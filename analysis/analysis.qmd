---
title: "Analysis"
format: gfm
---

## Analysis

```{r packages & data}
#| output: false

library(dplyr)
library(stargazer)
library(marginaleffects)
library(lme4)
library(margins)
library(data.table)
library(ggplot2)

data <- fread("./data/moddatafinal_LASTTIMEIPROMISE.csv")

```

## Format and summarize variables

```{r correct format of variables}

data <- data %>% 
  mutate(
    migrant = factor(migrant, levels = c(0, 1),
                     labels = c("nonmigrant", "migrant")),
    death_country = factor(death_country, levels = c("UK/Ireland", "Canada",
                                                     "South Africa", "Australia",
                                                     "New Zealand",
                                                     "United States of America")),
    birth10 = as.factor(birth10),
    death10 = as.factor(death10),
    gender = as.factor(gender),
    sib_size_cat = as.factor(sib_size_cat),
    birthorder_cat = as.factor(birthorder_cat),
    famid = as.numeric(famid),
    firstborn = factor(firstborn, levels = c('missing', '0', '1'))
    )

```

```{r descrtiptives}

summary(data$deathage)
summary(data$migrant)
table(data$death_country)
summary(data$birth10)
summary(data$death10)
summary(data$gender)
summary(data$sib_size_cat)
summary(data$famid)
table(data$firstborn)

```

```{r newdata}

# Make df where everyone has a parent in the data
data_par_complete <- data %>% 
  filter(miss.famid == F) %>% 
  select(-miss.famid)

summary(data_par_complete$sib_size_cat)

# Make df where only people with siblings are in data
data_only_siblings <- data_par_complete %>% 
  filter(sib.ct > 0)

```

## Family effects models

```{r Family effects model - migrant}

# Model 1 - migrant
fe1 <- lmer(deathage ~ migrant * birth10 + gender + sib_size_cat + (1|famid),
            data = data_par_complete) 

summary(fe1)

fe1.mm <- margins(fe1, variables = "migrant")
print(fe1.mm)

```

```{r migrant plots}

p <- summary(fe1.mm) # AME = 5.93, p < 0.001
p
print(signif(mean(fe1.mm$dydx_migrantmigrant)), 4) # same as above
#plot(fe1.mm, xlab = "migrant")


plot.p <- p %>% 
  ggplot(aes(
    x = factor,
    y = AME
  )) + 
  geom_point() +
  geom_errorbar(aes(
    ymin = lower,
    ymax = upper),
    width = 0.15) + 
  xlab("Migrant") + 
  ylab("Average Marginal Effect") + 
  ylim(c(5.5,6.5)) +
  theme_bw() + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

# save graph
ggsave(
  plot = plot.p,
  filename = "./analysis_output/fe1_base.png",
  width = 8.5,
  height = 5,
  units = "in"
)


```

```{r alt migrant - modified samples fe1}

fe1.sibs <- lmer(deathage ~ migrant * birth10 + gender + sib_size_cat + (1|famid),
         data = data_only_siblings) 
summary(fe1.sibs)

fe1.sibs.mm <- margins(fe1.sibs, variables = "migrant")
p.sibs <- summary(fe1.sibs.mm) # AME = 5.9335, p < 0.001
p.sibs

plot.p.sibs <- p.sibs %>% 
  ggplot(aes(
    x = factor,
    y = AME
  )) + 
  ggplot2::geom_point() +
  geom_errorbar(aes(
    ymin = lower,
    ymax = upper),
    width = 0.15) + 
  xlab("Migrant") + 
  ylab("Average Marginal Effect") + 
  ylim(c(6.5,8.5)) +
  theme_bw() + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

# save graph
ggsave(
  plot = plot.p.sibs,
  filename = "./analysis_output/fe1_sibs.png",
  width = 8.5,
  height = 5,
  units = "in"
)

```

## Death country

```{r Family effects - death country}

# Model 2 - destination country
fe2 <- lmer(deathage ~ death_country * birth10 + gender + sib_size_cat + (1|famid),
         data = data_par_complete)
summary(fe2)

fe2.mm <- margins(fe2, variables = "death_country")
q <- summary(fe2.mm)
q

q <- q %>% 
  mutate(factor = ifelse(factor == "death_countryAustralia", "Australia", factor),
         factor = ifelse(factor == "death_countrySouth Africa", "South Africa", factor),
         factor = ifelse(factor == "death_countryCanada", "Canada", factor),
         factor = ifelse(factor == "death_countryNew Zealand", "New Zealand", factor),
         factor = ifelse(factor == "death_countryUnited States of America", "USA", factor)) 

plot.q <- q %>% 
  ggplot(aes(
    x = factor,
    y = AME
  )) +
  geom_point() +
  geom_errorbar(aes(
    ymin = lower,
    ymax = upper), 
    width = 0.25) + 
  ylim(c(1,11.5)) +
  xlab("Destination Country") + 
  ylab("Average Marginal Effect") + 
  theme_bw()

# save graph
ggsave(
  plot = plot.q,
  filename = "./analysis_output/fe2_base.png",
  width = 8.5,
  height = 5,
  units = "in"
)


```


```{r Alt death country - modified samples fe2}

fe2.sibs <- lmer(deathage ~ death_country * birth10 + gender + sib_size_cat + (1|famid),
         data = data_only_siblings) 
summary(fe2.sibs)

fe2.sibs.mm <- margins(fe2.sibs, variables = "death_country")
q.sibs <- summary(fe2.sibs.mm) # AME = , p < 0.001
q.sibs

q.sibs <- q.sibs %>% 
  mutate(factor = ifelse(factor == "death_countryAustralia", "Australia", factor),
         factor = ifelse(factor == "death_countrySouth Africa", "South Africa", factor),
         factor = ifelse(factor == "death_countryCanada", "Canada", factor),
         factor = ifelse(factor == "death_countryNew Zealand", "New Zealand", factor),
         factor = ifelse(factor == "death_countryUnited States of America", "USA", factor)) 

plot.q.sibs <- q.sibs %>% 
  ggplot(aes(
    x = factor,
    y = AME
  )) +
  geom_point() +
  geom_errorbar(aes(
    ymin = lower,
    ymax = upper), 
    width = 0.25) + 
  ylim(c(1,11.5)) +
  xlab("Destination Country") + 
  ylab("Average Marginal Effect") + 
  theme_bw()

# save graph
ggsave(
  plot = plot.q.sibs,
  filename = "./analysis_output/fe2_base.png",
  width = 8.5,
  height = 5,
  units = "in"
)

```

```{r stargazer tables - fam effects models}

cov.labs <- c("Migrant", "Canada", "South Africa", "Australia", 
              "New Zealand", "United States of America")

tbl <- stargazer(fe1, fe2,
                 type = "html",
                 column.labels = c("Migrant", "Country of Death"),
                 covariate.labels = cov.labs,
                 dep.var.caption = "Dependent variable: Age at Death",
                 dep.var.labels = "",
                 keep.stat = c("n"),
                 add.lines=list(c("Sibling random effects", "Yes", "Yes"))
)

write(tbl, file = "./analysis_output/results_table.html", sep = ",")

```
